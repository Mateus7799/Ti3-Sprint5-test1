<p-toast />
<main>
  <p-toolbar>
    <ng-template #start>
      <section class="flex space-x-4">
        <p-iconfield iconPosition="left">
          <p-inputicon class="pi pi-search" />
          <input [(ngModel)]="searchText" type="text" pInputText class="w-96" />
        </p-iconfield>
        <p-button
          [outlined]="true"
          [rounded]="true"
          severity="secondary"
          label="Pesquisar"
          (click)="buscarPessoas()"
        ></p-button>
        @if (searchText.length > 0) {
          <p-button
            [outlined]="true"
            [rounded]="true"
            severity="secondary"
            label="Limpar Busca"
            icon="pi pi-times-circle"
            (click)="listarPessoas()"
          ></p-button>
        }
      </section>
    </ng-template>
    <ng-template #end>
      <p-button
        label="Cadastrar Pessoa"
        icon="pi pi-plus"
        (click)="abrirModalCadastrar()"
      ></p-button>
    </ng-template>
  </p-toolbar>
  <div>
    <h1 class="text-lg text-neutral-400 pt-4 font-semibold">
      Essa página inclui os clientes e fornecedores
    </h1>
  </div>
  <!-- <p-scrollpanel [style]="{ width: '100%', height: '300px', display: 'flex', gap:'0.25rem', flexWrap: 'wrap', paddingTop: '0.25rem', paddingBottom: '0,25rem'}"> -->
  <div class="flex gap-4 flex-wrap pt-4 pb-4">
    @if (pessoas.length > 0) {
      @for (pessoa of pessoas; track pessoa.id) {
        <p-card [style]="{ width: '45%' }">
          <ng-template #title>
            <section class="flex justify-between items-center">
              <div class="flex items-center">
                <p-avatar
                  [icon]="pessoa.cpfCnpj.length == 11 ? 'pi pi-user' : 'pi pi-building'"
                  class="mr-2"
                  size="large"
                  shape="circle"
                />
                <span class="font-bold text-primary">{{ pessoa.nome }}</span>
              </div>
              <p-button
                icon="pi pi-pen-to-square"
                [text]="true"
                severity="secondary"
                [rounded]="true"
                (click)="abrirModalEditar(pessoa)"
              ></p-button>
            </section>
          </ng-template>
          <ng-template #subtitle>
            <span class="text-sm text-gray-600">{{ pessoa.origem || 'Sem origem definida' }}</span>
          </ng-template>
          <div class="space-y-2">
            <p>
              <strong>{{ pessoa.cpfCnpj.length == 11 ? 'CPF' : 'CNPJ' }}:</strong>
              {{ pessoa.cpfCnpj | cpfCnpjMask }}
            </p>
            @if (pessoa.dataNascimento) {
              <p class="text-sm text-gray-700">
                <strong>Data de Nascimento:</strong>
                {{ pessoa.dataNascimento | date: 'dd/MM/yyyy' }}
              </p>
            }
          </div>
          <ng-template #footer>
            <div class="flex justify-end pt-2">
              <p-button
                label="Ver histórico"
                icon="pi pi-history"
                severity="secondary"
                [outlined]="true"
                (click)="abrirModalHistorico(pessoa)"
              />
            </div>
          </ng-template>
        </p-card>
      }
    } @else {
      <p-card
        [header]="
          searchText.length <= 0 ? 'Não há pessoas cadastradas!' : 'Não foram encontradas pessoas'
        "
        class="w-full"
      >
        <p class="m-0">
          {{
            searchText.length <= 0
              ? 'Comece a adicionar pessoas no sistema para vê-las aqui!'
              : 'Modifique seus parâmetros de busca e tente novamente!'
          }}
        </p>
      </p-card>
    }
  </div>

  @if (pessoas.length > 0) {
    <div class="flex justify-center pt-4">
      <p-paginator
        [rows]="itensPorPagina"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{totalRecords} pessoas"
        [totalRecords]="totalRegistros"
        [rowsPerPageOptions]="[4, 6, 8]"
        (onPageChange)="onPageChange($event)"
      ></p-paginator>
    </div>
  }

  <p-dialog
    [header]="editandoPessoa ? 'Editar Pessoa' : 'Cadastrar Nova Pessoa'"
    (onHide)="esconderFormularioModal(pessoaForm)"
    [modal]="true"
    [(visible)]="modalFormularioAberto"
    [draggable]="false"
    [style]="{ width: '35rem' }"
  >
    <form
      #pessoaForm="ngForm"
      class="flex flex-col w-full space-y-4"
      (ngSubmit)="enviarFormulario(pessoaForm)"
    >
      <div class="flex flex-col space-y-2">
        <label for="nome" class="font-semibold">Nome *</label>
        <input
          [ngModel]="editandoPessoa?.nome"
          required
          name="nome"
          id="nome"
          type="text"
          placeholder="Nome completo..."
          pInputText
        />
      </div>

      <div class="flex flex-col space-y-2">
        <label for="cpfCnpj" class="font-semibold">CPF/CNPJ *</label>
        <input
          [ngModel]="editandoPessoa?.cpfCnpj ? (editandoPessoa!.cpfCnpj | cpfCnpjMask) : ''"
          required
          #cpfCnpjInput
          name="cpfCnpj"
          id="cpfCnpj"
          type="text"
          placeholder="000.000.000-00 ou 00.000.000/0001-00"
          pInputText
          appCpfCnpjMask
          maxlength="18"
        />
      </div>

      @if (cpfCnpjInput.value.length < 15) {
        <div class="flex flex-col space-y-2">
          <label for="dataNascimento" class="font-semibold">Data de Nascimento *</label>
          <p-datepicker
            placeholder="Data de Nascimento"
            name="dataNascimento"
            [ngModel]="editandoPessoa?.dataNascimento"
            required
            [showIcon]="true"
            appendTo="body"
          ></p-datepicker>
        </div>
      }

      <div class="flex flex-col space-y-2">
        <label for="origem" class="font-semibold">Origem</label>
        <input
          [ngModel]="editandoPessoa?.origem"
          name="origem"
          id="origem"
          type="text"
          placeholder="Origem..."
          pInputText
        />
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <p-button
          label="Cancelar"
          severity="secondary"
          [outlined]="true"
          (click)="modalFormularioAberto = false; esconderFormularioModal(pessoaForm)"
        ></p-button>
        <p-button
          [label]="editandoPessoa ? 'Salvar Edições' : 'Cadastrar'"
          type="submit"
          [disabled]="pessoaForm.invalid"
        ></p-button>
      </div>
    </form>
  </p-dialog>

  <!-- Modal de Histórico -->
  <p-dialog
    [header]="'Histórico de ' + (pessoaHistorico?.nome || '')"
    (onHide)="fecharModalHistorico()"
    [modal]="true"
    [(visible)]="modalHistoricoAberto"
    [draggable]="false"
    [style]="{ width: '70rem', maxHeight: '80vh' }"
  >
    <div class="flex flex-col space-y-4">
      <!-- Barra de Pesquisa -->
      <div class="flex gap-4">
        <p-iconfield iconPosition="left" class="flex-1">
          <p-inputicon class="pi pi-search" />
          <input
            [(ngModel)]="searchHistorico"
            type="text"
            pInputText
            placeholder="Pesquisar por ID, produto ou número de série..."
            class="w-full"
            (input)="filtrarHistorico()"
          />
        </p-iconfield>
      </div>

      <!-- Loading -->
      @if (carregandoHistorico) {
        <div class="flex justify-center items-center p-8">
          <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
        </div>
      }

      <!-- Lista de Histórico -->
      @if (!carregandoHistorico && historicoFiltrado.length > 0) {
        <p-scrollpanel [style]="{ width: '100%', height: '500px' }">
          <div class="flex flex-col gap-4 pr-4">
            @for (item of historicoFiltrado; track item.tipo + '-' + (item.tipo === 'operacao' ? getOperacao(item).id : getServico(item).id)) {
              @if (item.tipo === 'operacao') {
                <p-card>
                  <ng-template #header>
                    <div class="flex justify-between items-center px-4 pt-3">
                      <div class="flex items-center gap-2">
                        <p-avatar
                          [icon]="getOperacao(item).tipo === 0 ? 'pi pi-dollar' : 'pi pi-shopping-cart'"
                          size="large"
                          shape="circle"
                        />
                        <div>
                          <h3 class="text-primary font-bold m-0">
                            Operação #{{ getOperacao(item).id }}
                          </h3>
                          <span class="text-sm text-neutral-500">
                            {{ item.data | date: 'dd/MM/yyyy HH:mm' }}
                          </span>
                        </div>
                      </div>
                      <p-message
                        [severity]="getOperacao(item).tipo === 0 ? 'success' : 'error'"
                        size="small"
                      >
                        {{ getTipoOperacaoLabel(getOperacao(item).tipo) }}
                      </p-message>
                    </div>
                  </ng-template>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <p class="text-sm">
                        <strong>Produto:</strong> {{ getOperacao(item).produto.numeroSerie }}
                      </p>
                      <p class="text-sm">
                        <strong>Aparelho:</strong> {{ getOperacao(item).produto.aparelho }}
                      </p>
                      <p class="text-sm">
                        <strong>Modelo:</strong> {{ getOperacao(item).produto.modelo }}
                      </p>
                    </div>
                    <div class="flex flex-col items-end">
                      <p class="text-sm">
                        <strong>Funcionário:</strong> {{ getOperacao(item).funcionario.nome }}
                      </p>
                      <p
                        class="text-lg font-bold"
                        [ngClass]="
                          getOperacao(item).tipo === 0 ? 'text-green-600' : 'text-red-600'
                        "
                      >
                        {{ getOperacao(item).valor | currency: 'BRL' }}
                      </p>
                    </div>
                  </div>
                  @if (getOperacao(item).observacoes) {
                    <div class="mt-3 pt-3 border-t border-neutral-200">
                      <p class="text-sm text-neutral-600">
                        <strong>Observações:</strong> {{ getOperacao(item).observacoes }}
                      </p>
                    </div>
                  }
                </p-card>
              } @else {
                <p-card>
                  <ng-template #header>
                    <div class="flex justify-between items-center px-4 pt-3">
                      <div class="flex items-center gap-2">
                        <p-avatar icon="pi pi-cog" size="large" shape="circle" />
                        <div>
                          <h3 class="text-primary font-bold m-0">
                            Serviço #{{ getServico(item).id }}
                          </h3>
                          <span class="text-sm text-neutral-500">
                            {{ item.data | date: 'dd/MM/yyyy' }}
                          </span>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <p-message severity="info" size="small">
                          {{ getTipoServicoLabel(getServico(item).tipo) }}
                        </p-message>
                        <p-message
                          [severity]="
                            getServico(item).status.id === 1 ? 'success' : 'secondary'
                          "
                          size="small"
                        >
                          {{ getServico(item).status.nome }}
                        </p-message>
                      </div>
                    </div>
                  </ng-template>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <p class="text-sm">
                        <strong>Produto:</strong> {{ getServico(item).produto.numeroSerie }}
                      </p>
                      <p class="text-sm">
                        <strong>Aparelho:</strong> {{ getServico(item).produto.aparelho }}
                      </p>
                      @if (getServico(item).produto.modelo) {
                        <p class="text-sm">
                          <strong>Modelo:</strong> {{ getServico(item).produto.modelo }}
                        </p>
                      }
                      @if (getServico(item).dataFim) {
                        <p class="text-sm">
                          <strong>Data Fim:</strong>
                          {{ getServico(item).dataFim | date: 'dd/MM/yyyy' }}
                        </p>
                      }
                    </div>
                    <div class="flex flex-col items-end">
                      <p class="text-lg font-bold text-primary">
                        {{ getServico(item).valor | currency: 'BRL' }}
                      </p>
                    </div>
                  </div>
                  @if (getServico(item).observacoes) {
                    <div class="mt-3 pt-3 border-t border-neutral-200">
                      <p class="text-sm text-neutral-600">
                        <strong>Observações:</strong> {{ getServico(item).observacoes }}
                      </p>
                    </div>
                  }
                </p-card>
              }
            }
          </div>
        </p-scrollpanel>
      }

      <!-- Mensagem de Não Encontrado -->
      @if (!carregandoHistorico && historicoFiltrado.length === 0 && searchHistorico.length > 0) {
        <p-card>
          <div class="flex flex-col items-center justify-center p-8 text-neutral-500">
            <i class="pi pi-search text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Nenhum resultado encontrado</h3>
            <p class="text-center">
              Não foi possível encontrar operações ou serviços com o termo "{{ searchHistorico }}"
            </p>
          </div>
        </p-card>
      }

      <!-- Mensagem de Histórico Vazio -->
      @if (!carregandoHistorico && historicoCompleto.length === 0) {
        <p-card>
          <div class="flex flex-col items-center justify-center p-8 text-neutral-500">
            <i class="pi pi-inbox text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Nenhum histórico encontrado</h3>
            <p class="text-center">
              Esta pessoa ainda não possui operações ou serviços registrados no sistema.
            </p>
          </div>
        </p-card>
      }
    </div>
  </p-dialog>
</main>
